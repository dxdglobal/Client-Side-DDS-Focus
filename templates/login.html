<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FocusRO - Login</title>
  <link rel="icon" type="image/x-icon" href="./icon.ico">
  <link rel="stylesheet" href="./static/login.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body onload="checkDatabase()">

  <div class="container">


    <div class="wave-bg"></div>

    <div class="logo">
      <img src="./static/dds-logo.png" alt="DDS Logo" width="340px" height="auto">
    </div>

    <div class="content">
      <div class="title">Automated Employee Monitoring Software</div>
      <div class="subtitle">Machine learning-based productivity & distraction detection</div>

      <div class="login-form">
        <input type="text" class="input-field" placeholder="Username or Email" id="username" autocomplete="username" />
        <input type="password" class="input-field" placeholder="Password" id="password"
          autocomplete="current-password" />
     



        <div class="checkbox-container">
             <div class="input-group">
  <input type="checkbox" id="rememberMe" />
  <label for="rememberMe" id="rememberMeLabel">Remember Me</label>
</div>
          <!-- <label class="save-password">
            <input type="checkbox" id="savePassword" /> 
            <span>Save Password</span>
          </label> -->
          <!-- <a href="https://crm.deluxebilisim.com/admin/authentication/forgot_password" class="forgot-password">Forgot Password?</a> -->
       <a href="https://crm.deluxebilisim.com/admin/authentication/forgot_password" 
   target="_blank" 
   rel="noopener noreferrer" 
   class="forgot-password">
   Forgot Password?
</a>
        </div>

        <button class="login-button" id="loginBtn" onclick="handleLogin()">LOGIN</button>
        

        <!-- <button class="guest-button" onclick="guestLogin()">Login as Guest</button> -->
      </div>
    </div>


    <div class="language-selector">
      <select id="languageSelector" onchange="changeLanguage()">
        <option value="en">English</option>
        <option value="tr">Turkish</option>
      </select>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle theme">
      <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
      <span class="theme-icon moon-icon">üåô</span>
    </button>

    <div class="version">DeluxeTime v1.4</div>
  </div>

  <!-- Staff Data Display -->
  <div class="staff-data">
    <h3>Staff Data:</h3>
    <ul id="staffList"></ul>
  </div>

  
  <!-- Scripts Section -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
    // üé® API FUNCTIONALITY REMOVED - USING STATIC COLORS ONLY
    
    // Utility function to darken color
    function darkenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    // Utility function to lighten color
    function lightenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    let staffData = []; // Store staff data globally

    function fetchStaffData() {
      fetch('/get-staff-data')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            console.log("Staff Data:", data.staff_data);
            staffData = data.staff_data;  // Store staff data in a global variable

            // Clear existing list items
            const staffList = document.getElementById('staffList');
            staffList.innerHTML = '';

            // Loop through the staff data and display it in a list
            data.staff_data.forEach(staff => {
              const listItem = document.createElement('li');
              listItem.textContent = `${staff.name} - ${staff.position}`;
              staffList.appendChild(listItem);
            });
          } else {
            console.error("Failed to fetch staff data:", data.message);
          }
        })
        .catch(error => {
          console.error("Error fetching staff data:", error);
        });
    }

    function checkDatabase() {
      fetch('/check-db-connection')
        .then(response => response.json())
        .then(data => {
          console.log("Database connection check response:", data);
          if (data.status === 'success') {
            Toastify({
              text: "Login Page",
              backgroundColor: "green",
              duration: 3000
            }).showToast();
          } else {
            Toastify({
              text: `Error: ${data.message}`,
              backgroundColor: "red",
              duration: 3000
            }).showToast();
          }
        })
        .catch(() => {
          Toastify({
            text: "Error checking database connection.",
            backgroundColor: "red",
            duration: 3000
          }).showToast();
        });
    }

    const translations = {
      en: {
        title: "Automated Employee Monitoring Software",
        subtitle: "Machine learning-based productivity & distraction detection",
        usernamePlaceholder: "Username or Email",
        rememberMe: "Remember Me",
        passwordPlaceholder: "Password",
        savePassword: "Save Password",
        forgotPassword: "Forgot Password?",
        loginButton: "LOGIN",
        guestButton: "Login as Guest",
        staffData: "Staff Data:",
        version: "DeluxeTime v1.5.0"
      },
      tr: {
        title: "ƒ∞≈ü Emri Takip Yazƒ±lƒ±mƒ±",
        subtitle: " ",
        usernamePlaceholder: "Kullanƒ±cƒ± Adƒ± veya E-posta",
        passwordPlaceholder: "≈ûifre",
        savePassword: "≈ûifreyi Kaydet",
        rememberMe: "≈ûifreyi Kaydet", 
        forgotPassword: "≈ûifremi Unuttum?",
        loginButton: "Gƒ∞Rƒ∞≈û",
        guestButton: "Misafir Olarak Giri≈ü Yap",
        staffData: "Personel Verileri:",
        version: "DeluxeTime v1.5.0"
      }
    };

    function changeLanguage() {
      const selectedLanguage = document.getElementById("languageSelector").value;
      sessionStorage.setItem('selectedLanguage', selectedLanguage);  // ‚úÖ Save to session

      const translation = translations[selectedLanguage];

      document.querySelector(".title").textContent = translation.title;
      document.querySelector(".subtitle").textContent = translation.subtitle;
      document.getElementById("username").placeholder = translation.usernamePlaceholder;
      document.getElementById("password").placeholder = translation.passwordPlaceholder;
      document.querySelector(".forgot-password").textContent = translation.forgotPassword;
      document.getElementById("loginBtn").textContent = translation.loginButton;
      document.querySelector(".staff-data h3").textContent = translation.staffData;
      document.querySelector(".version").textContent = translation.version;
      // document.getElementById("rememberMeLabel").textContent = translation.savePassword;
      document.getElementById("rememberMeLabel").textContent = translation.rememberMe;
    }

    async function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (!username || !password) {
        Toastify({
          text: "Please enter both username and password",
          backgroundColor: "red",
          duration: 3000
        }).showToast();
        return;
      }

      // Check if the email exists in the staff data
      const user = staffData.find(staff => staff.email === username);
      if (!user) {
        Toastify({
          text: "Email not found in staff data",
          backgroundColor: "red",  // Red for error
          duration: 3000
        }).showToast();
        return;
      }

      // If email exists, show "User is available" toast
      Toastify({
        text: `User is available:`,
        backgroundColor: "green",  // Green for success
        duration: 3000
      }).showToast();

      // Store first name, last name, profile image, and other details in sessionStorage
      sessionStorage.setItem('user', JSON.stringify({
        firstName: user.firstname,
        lastName: user.lastname,
        profileImage: user.profile_image,
        email: user.email,
        position: user.position, // Store additional fields here
        staffid: user.staffid // Staff ID
      }));

      // Compare the password directly without encryption
      if (user.password != password) {
        Toastify({
          text: "Login successful!",
          backgroundColor: "green",  // Green for success
          duration: 3000
        }).showToast();

        if (document.getElementById("rememberMe").checked) {
        localStorage.setItem("savedUsername", username);
        localStorage.setItem("savedPassword", password);
        localStorage.setItem("rememberMe", "true");
        } else {
          localStorage.removeItem("savedUsername");
          localStorage.removeItem("savedPassword");
          localStorage.setItem("rememberMe", "false");
          }

        // ‚úÖ Create daily log file automatically upon login
        await createDailyLogFile(user.email, user.staffid);

        localStorage.setItem("loginTime", Date.now());

        // Redirect to client.html after successful login
        window.location.href = 'client';  // Fixed redirection to client.html
      } else {
        Toastify({
          text: "Invalid password",  // Red for error
          backgroundColor: "red",
          duration: 3000
        }).showToast();
      }
    }

    window.onload = function () {
      checkDatabase();
      fetchStaffData();
      
      let defaultLang = sessionStorage.getItem('selectedLanguage') || 'tr';
      document.getElementById("languageSelector").value = defaultLang;
      changeLanguage(defaultLang); // Apply Turkish or saved language

    const savedUsername = localStorage.getItem("savedUsername");
    const savedPassword = localStorage.getItem("savedPassword");
    const rememberMe = localStorage.getItem("rememberMe");

    if (rememberMe === "true") {
      document.getElementById("username").value = savedUsername || '';
      document.getElementById("password").value = savedPassword || '';
      document.getElementById("rememberMe").checked = true;
    }

  };

  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const remember = document.getElementById("rememberMe").checked;

    if (remember) {
      localStorage.setItem("savedEmail", email);
      localStorage.setItem("savedPassword", password);
      localStorage.setItem("rememberMe", "true");
    } else {
      localStorage.removeItem("savedEmail");
      localStorage.removeItem("savedPassword");
      localStorage.setItem("rememberMe", "false");
    }
    };

  // ‚úÖ Function to create daily log file upon login
  async function createDailyLogFile(email, staffId) {
    try {
      const loginData = {
        email: email,
        staff_id: staffId,
        action: 'login',
        timestamp: new Date().toISOString(),
        date: new Date().toISOString().split('T')[0] // YYYY-MM-DD format
      };

      const response = await fetch('/create_daily_log_file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(loginData)
      });

      const result = await response.json();
      if (result.status === 'success') {
        console.log('‚úÖ Daily log file created:', result.s3_url);
      } else {
        console.error('‚ùå Failed to create daily log file:', result.message);
      }
    } catch (error) {
      console.error('‚ùå Error creating daily log file:', error);
    }
  }

  // ‚úÖ Theme Toggle Functionality
  function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Update button icon
    updateThemeIcon(newTheme);
    
    console.log('Theme changed to:', newTheme);
  }

  function updateThemeIcon(theme) {
    const sunIcon = document.querySelector('.theme-toggle .sun-icon');
    const moonIcon = document.querySelector('.theme-toggle .moon-icon');
    
    if (sunIcon && moonIcon) {
      if (theme === 'dark') {
        sunIcon.style.setProperty('display', 'none', 'important');
        moonIcon.style.setProperty('display', 'block', 'important');
      } else {
        sunIcon.style.setProperty('display', 'block', 'important');
        moonIcon.style.setProperty('display', 'none', 'important');
      }
    }
  }

  // Initialize theme on page load
  function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    console.log('Initializing theme:', savedTheme);
    document.body.setAttribute('data-theme', savedTheme);
    
    // Wait a bit for DOM to be ready
    setTimeout(() => {
      updateThemeIcon(savedTheme);
    }, 100);
  }

  // Call initialize theme
  initializeTheme();

  </script>

</body>

</html>