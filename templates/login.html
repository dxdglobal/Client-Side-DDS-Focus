<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FocusRO - Login</title>
  <link rel="icon" type="image/x-icon" href="./icon.ico">
  <link rel="stylesheet" href="./static/login.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
  <!-- Apply theme immediately to prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>

<body onload="checkDatabase()">

  <div class="container">


    <div class="wave-bg"></div>

    <div class="logo">
      <img src="./static/dds-logo.png" alt="DDS Logo" width="340px" height="auto">
    </div>

    <div class="content">
      <div class="title">Automated Employee Monitoring Software</div>
      <div class="subtitle">Machine learning-based productivity & distraction detection</div>

      <div class="login-form">
        <input type="text" class="input-field" placeholder="Username or Email" id="username" autocomplete="username" />
        <input type="password" class="input-field" placeholder="Password" id="password"
          autocomplete="current-password" />
     



        <div class="checkbox-container">
             <div class="input-group">
  <input type="checkbox" id="rememberMe" />
  <label for="rememberMe" id="rememberMeLabel">Remember Me</label>
</div>
          <!-- <label class="save-password">
            <input type="checkbox" id="savePassword" /> 
            <span>Save Password</span>
          </label> -->
          <!-- <a href="https://crm.deluxebilisim.com/admin/authentication/forgot_password" class="forgot-password">Forgot Password?</a> -->
       <a href="https://crm.deluxebilisim.com/admin/authentication/forgot_password" 
   target="_blank" 
   rel="noopener noreferrer" 
   class="forgot-password">
   Forgot Password?
</a>
        </div>

        <button class="login-button" id="loginBtn" onclick="handleLogin()">LOGIN</button>
        

        <!-- <button class="guest-button" onclick="guestLogin()">Login as Guest</button> -->
      </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle-btn" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode" style="position: absolute; top: 20px; right: 20px; background: #006039; border: 2px solid #006039; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; overflow: hidden;">
      <!-- Sun Icon (Light Mode) -->
      <svg class="sun-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 22px; height: 22px; position: absolute; left: 50%; top: 50%; transition: all 0.3s ease;">
        <g clip-path="url(#a)" stroke="#ffffff" stroke-width="1.5" stroke-miterlimit="10">
          <path d="M5 12H1M23 12h-4M7.05 7.05 4.222 4.222M19.778 19.778 16.95 16.95M7.05 16.95l-2.828 2.828M19.778 4.222 16.95 7.05" stroke-linecap="round"/>
          <path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" fill="currentColor" fill-opacity=".3"/>
          <path d="M12 19v4M12 1v4" stroke-linecap="round"/>
        </g>
      </svg>
      
      <!-- Moon Icon (Dark Mode) -->
      <svg class="moon-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" style="width: 22px; height: 22px; position: absolute; left: 50%; top: 50%; transition: all 0.3s ease; opacity: 0;">
        <path d="m32.8,29.3c-8.9-.8-16.2-7.8-17.5-16.6-.3-1.8-.3-3.7,0-5.4.2-1.4-1.4-2.3-2.5-1.6C6.3,9.7,2.1,16.9,2.5,25c.5,10.7,9,19.5,19.7,20.4,10.6.9,19.8-6,22.5-15.6.4-1.4-1-2.6-2.3-2-2.9,1.3-6.1,1.8-9.6,1.5Z" fill="none" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
      </svg>
    </button>

    <div class="language-selector">
      <select id="languageSelector" onchange="changeLanguage()">
        <option value="en">English</option>
        <option value="tr">Turkish</option>
      </select>
    </div>

    <div class="version">DeluxeTime v1.4</div>
  </div>

  <!-- Staff Data Display -->
  <div class="staff-data">
    <h3>Staff Data:</h3>
    <ul id="staffList"></ul>
  </div>

  
  <!-- Scripts Section -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
    // 🎨 API FUNCTIONALITY REMOVED - USING STATIC COLORS ONLY
    
    // Utility function to darken color
    function darkenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    // Utility function to lighten color
    function lightenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    let staffData = []; // Store staff data globally

    function fetchStaffData() {
      fetch('/get-staff-data')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            console.log("Staff Data:", data.staff_data);
            staffData = data.staff_data;  // Store staff data in a global variable

            // Clear existing list items
            const staffList = document.getElementById('staffList');
            staffList.innerHTML = '';

            // Loop through the staff data and display it in a list
            data.staff_data.forEach(staff => {
              const listItem = document.createElement('li');
              listItem.textContent = `${staff.name} - ${staff.position}`;
              staffList.appendChild(listItem);
            });
          } else {
            console.error("Failed to fetch staff data:", data.message);
          }
        })
        .catch(error => {
          console.error("Error fetching staff data:", error);
        });
    }

    function checkDatabase() {
      fetch('/check-db-connection')
        .then(response => response.json())
        .then(data => {
          console.log("Database connection check response:", data);
          if (data.status === 'success') {
            console.log("Login Page loaded successfully");
          } else {
            console.error(`Error: ${data.message}`);
          }
        })
        .catch(() => {
          console.error("Error checking database connection.");
        });
    }

    const translations = {
      en: {
        title: "Automated Employee Monitoring Software",
        subtitle: "Machine learning-based productivity & distraction detection",
        usernamePlaceholder: "Username or Email",
        rememberMe: "Remember Me",
        passwordPlaceholder: "Password",
        savePassword: "Save Password",
        forgotPassword: "Forgot Password?",
        loginButton: "LOGIN",
        guestButton: "Login as Guest",
        staffData: "Staff Data:",
        version: "DeluxeTime v1.4.0"
      },
      tr: {
        title: "İş Emri Takip Yazılımı",
        subtitle: " ",
        usernamePlaceholder: "Kullanıcı Adı veya E-posta",
        passwordPlaceholder: "Şifre",
        savePassword: "Şifreyi Kaydet",
        rememberMe: "Şifreyi Kaydet", 
        forgotPassword: "Şifremi Unuttum?",
        loginButton: "GİRİŞ",
        guestButton: "Misafir Olarak Giriş Yap",
        staffData: "Personel Verileri:",
        version: "DeluxeTime v1.4.0"
      }
    };

    function changeLanguage() {
      const selectedLanguage = document.getElementById("languageSelector").value;
      sessionStorage.setItem('selectedLanguage', selectedLanguage);  // ✅ Save to session

      const translation = translations[selectedLanguage];

      document.querySelector(".title").textContent = translation.title;
      document.querySelector(".subtitle").textContent = translation.subtitle;
      document.getElementById("username").placeholder = translation.usernamePlaceholder;
      document.getElementById("password").placeholder = translation.passwordPlaceholder;
      document.querySelector(".forgot-password").textContent = translation.forgotPassword;
      document.getElementById("loginBtn").textContent = translation.loginButton;
      document.querySelector(".staff-data h3").textContent = translation.staffData;
      document.querySelector(".version").textContent = translation.version;
      // document.getElementById("rememberMeLabel").textContent = translation.savePassword;
      document.getElementById("rememberMeLabel").textContent = translation.rememberMe;
    }

    async function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (!username || !password) {
        console.error("Please enter both username and password");
        return;
      }

      // Check if the email exists in the staff data
      const user = staffData.find(staff => staff.email === username);
      if (!user) {
        console.error("Email not found in staff data");
        return;
      }

      // If email exists, log success
      console.log(`User is available: ${username}`);

      // Store first name, last name, profile image, and other details in sessionStorage
      sessionStorage.setItem('user', JSON.stringify({
        firstName: user.firstname,
        lastName: user.lastname,
        profileImage: user.profile_image,
        email: user.email,
        position: user.position, // Store additional fields here
        staffid: user.staffid // Staff ID
      }));

      // Compare the password directly without encryption
      if (user.password != password) {
        console.log("Login successful!");

        if (document.getElementById("rememberMe").checked) {
        localStorage.setItem("savedUsername", username);
        localStorage.setItem("savedPassword", password);
        localStorage.setItem("rememberMe", "true");
        } else {
          localStorage.removeItem("savedUsername");
          localStorage.removeItem("savedPassword");
          localStorage.setItem("rememberMe", "false");
          }

        // ✅ Create daily log file automatically upon login
        await createDailyLogFile(user.email, user.staffid);

        // Redirect to client.html after successful login
        window.location.href = 'client';  // Fixed redirection to client.html
      } else {
        console.error("Invalid password");
      }
    }

    window.onload = function () {
      checkDatabase();
      fetchStaffData();
      
      let defaultLang = sessionStorage.getItem('selectedLanguage') || 'tr';
      document.getElementById("languageSelector").value = defaultLang;
      changeLanguage(defaultLang); // Apply Turkish or saved language

    const savedUsername = localStorage.getItem("savedUsername");
    const savedPassword = localStorage.getItem("savedPassword");
    const rememberMe = localStorage.getItem("rememberMe");

    if (rememberMe === "true") {
      document.getElementById("username").value = savedUsername || '';
      document.getElementById("password").value = savedPassword || '';
      document.getElementById("rememberMe").checked = true;
    }

  };

  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const remember = document.getElementById("rememberMe").checked;

    if (remember) {
      localStorage.setItem("savedEmail", email);
      localStorage.setItem("savedPassword", password);
      localStorage.setItem("rememberMe", "true");
    } else {
      localStorage.removeItem("savedEmail");
      localStorage.removeItem("savedPassword");
      localStorage.setItem("rememberMe", "false");
    }
    };

  // ✅ Function to create daily log file upon login
  async function createDailyLogFile(email, staffId) {
    try {
      const loginData = {
        email: email,
        staff_id: staffId,
        action: 'login',
        timestamp: new Date().toISOString(),
        date: new Date().toISOString().split('T')[0] // YYYY-MM-DD format
      };

      const response = await fetch('/create_daily_log_file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(loginData)
      });

      const result = await response.json();
      if (result.status === 'success') {
        console.log('✅ Daily log file created:', result.s3_url);
      } else {
        console.error('❌ Failed to create daily log file:', result.message);
      }
    } catch (error) {
      console.error('❌ Error creating daily log file:', error);
    }
  }

  // ====== DARK/LIGHT MODE TOGGLE ======
  function toggleTheme() {
    const body = document.body;
    const isDarkMode = body.classList.toggle('dark-mode');
    
    // Save preference to localStorage
    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    
    // Update icons
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    
    if (isDarkMode) {
      sunIcon.style.opacity = '0';
      sunIcon.style.transform = 'translate(-50%, -50%) rotate(-180deg) scale(0)';
      moonIcon.style.opacity = '1';
      moonIcon.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1)';
    } else {
      sunIcon.style.opacity = '1';
      sunIcon.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1)';
      moonIcon.style.opacity = '0';
      moonIcon.style.transform = 'translate(-50%, -50%) rotate(180deg) scale(0)';
    }
  }

  // Load saved theme preference on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      const sunIcon = document.querySelector('.sun-icon');
      const moonIcon = document.querySelector('.moon-icon');
      sunIcon.style.opacity = '0';
      sunIcon.style.transform = 'translate(-50%, -50%) rotate(-180deg) scale(0)';
      moonIcon.style.opacity = '1';
      moonIcon.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1)';
    }
  });

  </script>

</body>

</html>