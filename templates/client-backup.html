<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/client.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="/eel.js"></script>
    <title>DDS-FocusPro V-1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    </head>
<body>

    <div class="container">
        <div class="header">
            <div class="logo">DDSFocusPro v-1.2</div>
            <div class="user-controls" style="display: flex; align-items: center; gap: 10px;">
                <img id="profileImage" src="https://crm.deluxebilisim.com/assets/images/user_placeholder.png"
                    style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                <span id="displayUserName" style="color: white; font-weight: bold; font-size: 18px;">Loading...</span>
                <button id="logout" onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background-color: #ffffff; color: #006039; border: none; border-radius: 4px; cursor: pointer;    border: solid 2px transparent;font-size: 12px;">Logout</button>
            </div>
        </div>

        <div class="main">
            <div class="grid-container">
                <div>
                    <div class="form-group">
                        <label for="clientNameInput">Client</label>
                        <input type="text" class="form-control" id="clientNameInput" style="width: 90%" readonly />
                    </div>
                    <div class="form-group">
                        <label for="project">Project</label>
                        <select id="project" class="form-control" onchange="loadTasksForProject()" style="width: 90%"></select>
                    </div>
                    <div class="form-group">
                        <label for="task">Task</label>
                        <select id="task" class="form-control" style="width: 90%">
                            <option disabled selected value="">-- Select a Task --</option>
                        </select>
                    </div>
                </div>

                <div class="timer-container">
                    <div class="state-circle" id="stateCircle">
                        <div class="state-label" id="stateLabel">WORK</div>
                    </div>

                    <div class="timer-display">
                        <div class="timer-unit">
                            <div class="timer-value" id="hours">00</div>
                            <div class="timer-label">HRS</div>
                        </div>
                        <div class="timer-unit">
                            <div class="timer-value" id="minutes">00</div>
                            <div class="timer-label">MIN</div>
                        </div>
                        <div class="timer-unit">
                            <div class="timer-value" id="seconds">00</div>
                            <div class="timer-label">SEC</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-button start-button" id="startBtn">START</button>
                        <button class="action-button reset-button" id="resetBtn" style="background-color: orange;">Finish</button>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label for="todayDate">Today</label>
                        <input type="text" class="form-control" id="todayDate" disabled />
                    </div>
                    <!-- <div class="form-group">
                        <label>Mode</label>
                        <input type="text" class="form-control" id="modeInput" value="Normal" disabled />
                    </div> -->
                    <div class="form-group">
                        <label for="totaltimecount">Total Time Count</label>
                        <div id="totaltimecount" class="form-control">00:00</div>

                        <!-- <input type="text" class="form-control" id="totaltimecount" value="00:00" disabled /> -->
                    </div>
                    <div class="form-group">
                        <label  for="loggingInput">Screen Recording</label>
                        <input type="text" class="form-control" id="loggingInput" value="NO" disabled />
                    </div>
                </div>
            
                
            </div>

<div id="work-animation" style="display: none; text-align: center; margin-top: 20px;">
  <img src="" alt="Working Animation" style="width: auto; border-radius: 8px; max-width: 250px;" />
  <p style="margin-top: 8px; font-weight: bold;">Welcome...</p>
</div>
        </div>

        <!-- <div class="footer"></div> -->

    </div>

<!-- Improved Modal -->
<div id="finishModal" class="modal">
    <div class="modal-content">
         <span class="modal-close" onclick="closeModal()">√ó</span>
        <h2 id="modalTitle">üìù Task Completion</h2>
        <p id="modalDesc">Please describe what you have completed for this task:</p>
        <textarea id="taskDetailInput" placeholder="Type your task details here..." rows="5"></textarea>
        <div class="modal-buttons">
            <button  id="modalSubmitBtn" class="modal-btn submit-btn" onclick="submitTaskDetails()">Submit</button>
            <!-- <button class="modal-btn cancel-btn" onclick="closeModal()">Cancel</button> -->
        </div>
    </div>
</div>



<div id="syncLoader" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 9999;
    justify-content: center;
    align-items: center;
">
    <div style="padding: 20px; background: white; border-radius: 8px; font-weight: bold;">
        üîÑ Syncing timesheets...Please wait
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>


    <script>
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top", 
                position: "right",
                backgroundColor: type === 'error' ? "#e74c3c" : "#27ae60",
                close: true
            }).showToast();
        }
        
        function logout() {
            sessionStorage.clear();
            window.location.href = '/';
        }
        
        let timerInterval, totalSeconds = 0;
        let isTimerRunning = false;
        let currentTaskId = null, sessionStartTime = null;
        let selectedProjectName = '', selectedTaskName = '', user = null;
        let idleSeconds = 0;
        const IDLE_LIMIT_SECONDS = 60;
        








































        window.onload = function () {
            const lang = sessionStorage.getItem('selectedLanguage') || 'en';
            applyClientLanguage(lang);
            const todayDateField = document.getElementById('todayDate');
            const today = new Date();
            todayDateField.value = today.toLocaleDateString('en-CA');

        
            user = JSON.parse(sessionStorage.getItem('user'));
            if (user) {
                document.getElementById('displayUserName').innerText = user.firstName;
                document.getElementById('clientNameInput').value = user.firstName;
                // document.getElementById('profileImage').src = `https://crm.deluxebilisim.com/uploads/staff_profile_images/${user.staffid}/small_${user.profileImage}`;
                const profileImg = document.getElementById('profileImage');
                const imgUrl = `https://crm.deluxebilisim.com/uploads/staff_profile_images/${user.staffid}/small_${user.profileImage}`;
                profileImg.src = imgUrl;
                profileImg.onerror = function () {
                    this.onerror = null; // prevent infinite loop
                    this.src = "../static/images/user_placeholder.png"; // Local fallback
                };

                fetchAIProjects(user);
                saveUserProjectsToCache(user);
            }
        };
        
        document.getElementById('startBtn').addEventListener('click', function () {
            const taskSelect = document.getElementById('task');
            const selectedTaskOption = taskSelect.options[taskSelect.selectedIndex];
            const taskId = taskSelect.value;
        
            if (!taskId || taskId === "" || selectedTaskOption.disabled) {
                showToast('‚ö†Ô∏è Please select a task first!', 'error');
                return;
            }
        
            if (!isTimerRunning) {
                currentTaskId = taskId;
                sessionStartTime = new Date().toISOString();
                selectedProjectName = document.getElementById('project').selectedOptions[0]?.textContent || '';
                selectedTaskName = selectedTaskOption.textContent;
        
                fetch('/start_screen_recording', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        project: selectedProjectName,
                        task: selectedTaskName
                    })
                }).then(res => res.json())
                //   .then(data => console.log("üé• Recording started:", data))
                  .catch(console.error);
        
                startTimer();
            }
            //  else {
            //     stopScreenRecording();
            //     pauseTimer();
            // }
        });
        

        
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (totalSeconds < 10) {
                // resetTimer();
                // stopScreenRecording();
                        const lang = sessionStorage.getItem('selectedLanguage') || 'en';
        const message = translations[lang].minWorkWarning;
        showToast(message, 'error');
                return;
            }
            openModal();
        });
        
        // let sessionStartTime;
        function startTimer() {
           // clearInterval(timerInterval);
            sessionStartTime = Math.floor(Date.now() / 1000); 
            const unixStart = Math.floor(sessionStartTime / 1000);
            // console.log("‚è±Ô∏è Session Start Timestamp:", sessionStartTime);



            console.log("üì§ Sending to /start_task_session:");
            console.log({
                email: user.email,
                staff_id: String(user.staffid),
                task_id: currentTaskId,
                start_time: sessionStartTime
            });


    fetch('/start_task_session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
        email: user.email,
        staff_id: String(user.staffid),
        task_id: currentTaskId,
        start_time: sessionStartTime  // üî• Already a number

        
    })
    })
    .then(res => res.json())
    .then(data => {
        console.log("üì§ Sent start time:", sessionStartTime);
        console.log("üì§ Sent task ID   :", currentTaskId);
        console.log("üì§ Sent staff ID  :", user.staffid);
        console.log("üì• Server response:", data);
    })
    .catch(console.error);






            isTimerRunning = true;
            document.getElementById('startBtn').disabled = true;

            document.getElementById('startBtn').style.backgroundColor = 'gray';
            document.getElementById('project').disabled = true;
            document.getElementById('task').disabled = true;
            const lang = sessionStorage.getItem('selectedLanguage') || 'en';
document.getElementById('loggingInput').value = lang === 'tr' ? 'EVET' : 'YES';

            timerInterval = setInterval(updateTimerDisplay, 1000);
        }


        
        function pauseTimer() {
            // clearInterval(timerInterval);
            // isTimerRunning = false;
            // document.getElementById('startBtn').innerText = 'START';
            // document.getElementById('startBtn').style.backgroundColor = 'green';
        }
        function resetTimer() {
    clearInterval(timerInterval);
    totalSeconds = 0;
    isTimerRunning = false;

    // Reset display
    document.getElementById('hours').innerText = '00';
    document.getElementById('minutes').innerText = '00';
    document.getElementById('seconds').innerText = '00';

    // ‚úÖ Reactivate the Start button
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').style.backgroundColor = 'green';

    // Enable dropdowns again
    const projectSelect = document.getElementById('project');
    const taskSelect = document.getElementById('task');
    projectSelect.disabled = false;
    taskSelect.disabled = false;

    // Reset dropdowns
    projectSelect.selectedIndex = 0;
    const lang = sessionStorage.getItem('selectedLanguage') || 'en';
    const taskPlaceholder = lang === 'tr' ? '-- ƒ∞≈ü Emri Se√ßin --' : '-- Select a Task --';
    taskSelect.innerHTML = `<option disabled selected>${taskPlaceholder}</option>`;

    // Logging input reset
    document.getElementById('loggingInput').value = lang === 'tr' ? 'HAYIR' : 'NO';
    document.getElementById('totaltimecount').innerText = `0 min 0 sec`;
}

        
        function updateTimerDisplay() {
            totalSeconds++;
            document.getElementById('hours').innerText = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            document.getElementById('minutes').innerText = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            document.getElementById('seconds').innerText = String(totalSeconds % 60).padStart(2, '0');
       
        // üëá Live update Total Time Count
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    document.getElementById('totaltimecount').innerText = `${mins} min ${secs} sec`;
       
        }
        
        function stopScreenRecording() {
            fetch('/stop_screen_recording', { method: 'POST' })
            .then(res => res.json())
            // .then(data => console.log("üõë Recording stopped:", data))
            .catch(console.error);
        }
        
        function fetchAIProjects(user) {
            const projectSelect = document.getElementById('project');
            const lang = sessionStorage.getItem('selectedLanguage') || 'en';
            const t = {
                en: { loadingProjects: "Loading projects..." },
                tr: { loadingProjects: "Projeler y√ºkleniyor..." }
            };
            projectSelect.innerHTML = `<option disabled selected>${t[lang].loadingProjects}</option>`;

            fetch('/get_ai_filtered_projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user.email, username: `${user.firstName} ${user.lastName || ''}` })
            })
            .then(response => response.json())
            .then(data => {
                const projects = data.projects || [];
                projectSelect.innerHTML = '';
                const lang = sessionStorage.getItem('selectedLanguage') || 'en';
        const t = {
            en: { selectProject: "Select a Project" },
            tr: { selectProject: "Proje Se√ßin" }
        };
        const defaultOption = new Option(t[lang].selectProject, '');

                projectSelect.appendChild(defaultOption);
                projects.forEach(project => {
                    const option = new Option(project.name || project.projectname || 'Unnamed Project', project.id);
                    projectSelect.appendChild(option);
                });
                // showToast(`‚úÖ Found ${projects.length} projects`);
            })
            .catch(error => {
                console.error(error);
                showToast('‚ùå Error loading projects', 'error');
            });
        }
        
        function loadTasksForProject() {
            const projectId = document.getElementById('project').value;
            const taskSelect = document.getElementById('task');
            if (!projectId) {
                const lang = sessionStorage.getItem('selectedLanguage') || 'en';
                const taskPlaceholder = lang === 'tr' ? '-- ƒ∞≈ü Emri Se√ßin --' : '-- Select a Task --';
                taskSelect.innerHTML = `<option disabled selected>${taskPlaceholder}</option>`;

                return;
            }
            const lang = sessionStorage.getItem('selectedLanguage') || 'en';
            const loadingText = lang === 'tr' ? 'G√∂revler y√ºkleniyor...' : 'Loading tasks...';
            taskSelect.innerHTML = `<option disabled selected>${loadingText}</option>`;

            fetch(`/get_tasks/${projectId}`)
            .then(response => response.json())
            .then(data => {
                taskSelect.innerHTML = '';
                const lang = sessionStorage.getItem('selectedLanguage') || 'en';
                const taskPlaceholder = lang === 'tr' ? '-- ƒ∞≈ü Emri Se√ßin --' : '-- Select a Task --';
                const defaultOption = new Option(taskPlaceholder, '');
                defaultOption.disabled = true;
                defaultOption.selected = true;
                taskSelect.appendChild(defaultOption);
                (data.tasks || []).forEach(task => {
                    const option = new Option(task.name || task.subject || 'Unnamed Task', task.id);
                    taskSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error(error);
                taskSelect.innerHTML = '<option disabled>Error loading tasks</option>';
            });
        }
        
        function saveUserProjectsToCache(user) {
            fetch('/cache_user_projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user.email, username: user.firstName, projects: user.projects })
            }).then(response => response.json()).catch(console.error);
        }
        
        function fetchLoggedTaskTimes() {
            fetch(`/get_task_time_summary/${user.email}`)
                .then(res => res.json())
                .then(data => {
                    // console.log("üïí Task time summary:", data.summary);
                })
                .catch(err => console.error("‚ùå Error loading task times:", err));
        }
        
        function openModal() {
            // clearInterval(timerInterval); 
            document.getElementById('finishModal').style.display = 'flex';
            const lang = sessionStorage.getItem('selectedLanguage') || 'en';
document.getElementById('loggingInput').value = lang === 'tr' ? 'EVET' : 'YES';


        }
        
        function closeModal() {
            document.getElementById('finishModal').style.display = 'none';
        }
    
        




















async function submitTaskDetails() {
    await sendTimesheetToBackend();
    const detailText = document.getElementById('taskDetailInput').value.trim();
    if (!detailText) {
        showToast('‚ö†Ô∏è Please enter task details!', 'error');
        return;
    }

    const end_time_unix = Math.floor(Date.now() / 1000); // UNIX format
    const taskId = document.getElementById('task').value;

    console.log("üì§ Sending to /end_task_session:");
    console.log("üìß Email:", user.email);
    console.log("üÜî Task ID:", taskId);
    console.log("üïê End Time (UNIX):", end_time_unix);
    console.log("üìù Note:", detailText);

    try {
        const saveRes = await fetch('/end_task_session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: user.email,
                staff_id: String(user.staffid),
                task_id: taskId,
                end_time: end_time_unix,
                note: detailText
            })
        });

        const saveJson = await saveRes.json();
        showToast('‚úÖ Task details saved!');
        
        // Reset and sync logic...
        closeModal();
        resetTimer();
        showLoader();

        await fetch('/submit_all_data_files', { method: 'POST' });
        await fetch('/upload_screenshots', { method: 'POST' });

    } catch (error) {
        console.error("‚ùå Error:", error);
    } finally {
        hideLoader();
    }
}




















async function sendTimesheetToBackend() {
    const payload = [
        {
            task_id: document.getElementById('task').value,
            start_time: "10:00:00", // üëà yeh tum calculate ya assign kar sakte ho
            end_time: "12:00:00",   // üëà current time use bhi kar sakte ho
            staff_id: String(user.staffid),
            hourly_rate: "5.00",
            note: document.getElementById('taskDetailInput').value.trim()
        }
    ];

    try {
        const res = await fetch('/insert_user_timesheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        console.log("‚úÖ Server response:", result);
        showToast("‚úÖ Timesheet sent!");
    } catch (error) {
        console.error("‚ùå Error sending timesheet:", error);
        // showToast("‚ùå Failed to send!", "error");
    }
}




        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs}h ${mins}m ${secs}s`;
        }
        
        function syncAllUsers() {
            fetch('/submit_all_data_files', {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                console.log(data);
                showToast(data.message || 'Synced successfully');
            })
            .catch(err => {
                console.error(err);
                // showToast('‚ùå Failed to sync all users', 'error');
            });
        }
        
   function showLoader() {
    const lang = sessionStorage.getItem('selectedLanguage') || 'en';
    const messages = {
        en: 'üîÑ Syncing timesheets...Please wait',
        tr: 'üîÑ Zaman √ßizelgeleri senkronize ediliyor... L√ºtfen bekleyin'
    };
    document.getElementById('syncLoader').innerHTML = `
        <div style="padding: 20px; background: white; border-radius: 8px; font-weight: bold;">
            ${messages[lang]}
        </div>
    `;
    document.getElementById('syncLoader').style.display = 'flex';
}

        
        function hideLoader() {
            document.getElementById('syncLoader').style.display = 'none';





        }







window.addEventListener('DOMContentLoaded', () => {
    const animationBox = document.getElementById('work-animation');
    const gifImg = animationBox.querySelector('img');

    const gifs = [
      "https://media.tenor.com/bnYAs3wmjdYAAAAM/keyboard-type.gif",
      "https://i.gifer.com/embedded/download/11gv.gif",
      "https://www.icegif.com/wp-content/uploads/icegif-1850.gif",
      "https://www.icegif.com/wp-content/uploads/icegif-1852.gif",

      "https://gifdb.com/images/high/jabril-typing-with-toes-y859gmgutpzs3aqj.webp",

      "https://i.gifer.com/embedded/download/Cdm.gif",
      "https://i.gifer.com/embedded/download/So5.gif",
      "https://i.gifer.com/embedded/download/3XJG.gif",
      "https://i.gifer.com/embedded/download/3ev.gif",
      "https://i.gifer.com/embedded/download/Dx.gif",
      "https://i.gifer.com/embedded/download/2IN3.gif"
    ];

    const randomGif = gifs[Math.floor(Math.random() * gifs.length)];
    gifImg.src = randomGif;

    animationBox.classList.add('show');
    animationBox.style.display = 'block';

    setTimeout(() => {
        animationBox.classList.remove('show');
        setTimeout(() => {
            animationBox.style.display = 'none';
        }, 1000);
    }, 20000);
});











function applyClientLanguage(lang) {


const translations = {
  en: {
            welcome: "Welcome...",
            logging: "Logging",
            total: "Total Time Count",
            loadingTasks: "Loading tasks...",
            today: "Today",
            work: "WORK",
            start: "START",
            finish: "Finish",
            hrs: "HRS",
            min: "MIN",
            sec: "SEC",
            modalTitle: "üìù Task Completion",
            modalDesc: "Please describe what you have completed for this task:",
            submit: "Submit",
            selectTask: "-- Select a Task --",
            loadingProjects: "Loading projects...",
            user: "User",
            project: "Project",
            task: "Task",
            client: "Client",
             modalTitle: "üìù Task Completion",
            modalDesc: "Please describe what you have completed for this task:",
            modalPlaceholder: "Type your task details here...",
            submit: "Submit",
            selectProject: "Select a Project",
            minWorkWarning: "‚ö†Ô∏è You must work at least 1 minute to finish a task.",
            logout: "Logout"
  },
  tr: {
    welcome: "Ho≈ü geldin...",
            logging: "Ekran Kaydƒ±",
            total: "Toplam S√ºre",
            minWorkWarning: "‚ö†Ô∏è Bir g√∂revi bitirmek i√ßin en az 1 dakika √ßalƒ±≈ümalƒ±sƒ±nƒ±z.",
            today: "Tarih",
            work: "√áALI≈ûMA",
            loadingTasks: "G√∂revler y√ºkleniyor...",
            start: "BA≈ûLAT",
            finish: "Bitir",
            hrs: "SA",
            min: "DK",
            sec: "SN",
            modalTitle: "üìù ƒ∞≈ü Tamamlandƒ±",
            modalDesc: "Bu ƒ∞≈ü Emri i√ßin ne yaptƒ±ƒüƒ±nƒ±zƒ± a√ßƒ±klayƒ±n:",
            submit: "G√∂nder",
            selectTask: "-- ƒ∞≈ü Emri Se√ßin --",
            loadingProjects: "Projeler y√ºkleniyor...",
            user: "Kullanƒ±cƒ±",
            project: "Proje",
            task: "ƒ∞≈ü Emri",
            client: "Personel",
              modalTitle: "üìù ƒ∞≈ü Emri Tamamlandƒ±",
            modalDesc: "Bu i≈ü emri i√ßin ne yaptƒ±ƒüƒ±nƒ±zƒ± a√ßƒ±klayƒ±n:",
            modalPlaceholder: "ƒ∞≈ü Emri detaylarƒ±nƒ± buraya yazƒ±n...",
            submit: "G√∂nder",
            selectProject: "Proje Se√ßin",
            logout: "√áƒ±kƒ±≈ü Yap"
  }
};

    
    
    
    
    
    
    
    
    
    
    
    const t = translations[lang];
    document.querySelector("#work-animation p").textContent = t.welcome;
    document.getElementById('stateLabel').textContent = t.work;

        document.querySelectorAll(".timer-label")[0].textContent = t.hrs;
    document.querySelectorAll(".timer-label")[1].textContent = t.min;
    document.querySelectorAll(".timer-label")[2].textContent = t.sec;

        // Update button text
    document.getElementById("startBtn").textContent = t.start;
    document.getElementById("resetBtn").textContent = t.finish;

    // Safely update labels
    const allLabels = document.querySelectorAll('label');
    allLabels.forEach(label => {
        const htmlFor = label.getAttribute('for');
        if (htmlFor === 'loggingInput') label.textContent = t.logging;
        if (htmlFor === 'totaltimecount') label.textContent = t.total;
        if (htmlFor === 'todayDate') label.textContent = t.today;
        if (htmlFor === "clientNameInput") label.textContent = t.client;
        if (htmlFor === "project") label.textContent = t.project;
        if (htmlFor === "task") label.textContent = t.task;
        if (htmlFor === "loggingInput") label.textContent = t.logging;
        if (htmlFor === "totaltimecount") label.textContent = t.total;
        if (htmlFor === "todayDate") label.textContent = t.today;
    });

      // Update dropdown placeholders
    const projectDropdown = document.getElementById("project");
    if (projectDropdown.options.length > 0) {
        projectDropdown.options[0].textContent = t.selectProject;
    }

    const taskDropdown = document.getElementById("task");
    if (taskDropdown.options.length > 0) {
        taskDropdown.options[0].textContent = t.selectTask;
    }

        // Modal translations
    document.getElementById('modalTitle').textContent = t.modalTitle;
    document.getElementById('modalDesc').textContent = t.modalDesc;
    document.getElementById('modalSubmitBtn').textContent = t.submit;
    document.getElementById('taskDetailInput').placeholder = t.modalPlaceholder;
    document.getElementById("logout").textContent = t.logout;
    



    const loggingInput = document.getElementById('loggingInput');
    if (loggingInput) {
    const currentVal = loggingInput.value.toUpperCase();
    if (currentVal === 'YES' || currentVal === 'EVET') {
        loggingInput.value = lang === 'tr' ? 'EVET' : 'YES';
    } else if (currentVal === 'NO' || currentVal === 'HAYIR') {
        loggingInput.value = lang === 'tr' ? 'HAYIR' : 'NO';
    }
    }
}




























// ‚úÖ Inject into <script> block of client.html or external JS file
window.addEventListener("load", () => {
    if (isTimerRunning) {
        console.log("üõë App loaded: Auto-stopping timer");
        resetTimer();
        stopScreenRecording();
    }
});

window.addEventListener("beforeunload", async (event) => {
    if (isTimerRunning) {
        console.log("‚ùå App closing: Auto-stopping timer & saving session");

        const detailText = "Auto-saved due to app exit.";
        const end_time_unix = Math.floor(Date.now() / 1000);

        try {
            await fetch('/end_task_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: user.email,
                    staff_id: String(user.staffid),
                    task_id: currentTaskId,
                    end_time: end_time_unix,
                    note: detailText
                })
            });
        } catch (err) {
            console.error("‚ùå Failed to save task before exit:", err);
        }

        resetTimer();
        stopScreenRecording();
    }
});



        </script>
        



</body>
</html>
