<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DDS-FocusPro V-1.4</title>

  <!-- Main Application Styles -->
  <link rel="stylesheet" href="../static/client.css" />
  
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://dxdglobal.com/wp-content/uploads/2024/12/cropped-Favicon-1-180x180.webp">

</head>

<body>
  <!-- Center Arrow Drawer Button -->
  <button class="drawer-arrow-btn" id="drawerArrowBtn" onclick="toggleDrawer()" aria-label="Toggle navigation menu">
    <span class="arrow-icon">‚ñ∂</span>
  </button>

  <div class="container">
    <!-- Header -->
<div class="header">
        <div class="logo">
            <figure>
                <img src="./static/dds-logo.png" alt="DDS Logo" width="113px" height="auto" style="width: 113px !important;">
            </figure>
        </div>
        <div class="user-controls">
            <img id="profileImage" src="https://crm.deluxebilisim.com/assets/images/user_placeholder.png">
            <span id="displayUserName" style="margin-right: 10px;">Loading ...</span>
            
            <!-- Theme Toggle Button -->
            <button class="theme-toggle-client" id="themeToggleClient" onclick="toggleClientTheme()" aria-label="Toggle theme">
              <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
              <span class="theme-icon moon-icon">üåô</span>
            </button>
            
            <!-- Language Dropdown -->
            <div class="language-dropdown">
              <button class="language-btn" onclick="toggleLanguageDropdown()">
                <span id="currentLanguage">Dil</span>
                <span class="dropdown-arrow">‚ñº</span>
              </button>

              <!-- Language Dropdown Content -->

                <div class="language-dropdown-content" id="languageDropdown">
                   <div class="language-option" id="option-tr" onclick="selectLanguage('tr')">
                    <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 356.18"><g fill-rule="nonzero"><path fill="#E30A17" d="M28.137 0H483.86C499.337 0 512 12.663 512 28.14v299.9c0 15.477-12.663 28.14-28.14 28.14H28.137C12.663 356.18 0 343.517 0 328.04V28.14C0 12.663 12.663 0 28.137 0z"/><path fill="#fff" d="M253.365 130.516c-15.783-24.923-43.598-41.473-75.281-41.473-49.179 0-89.047 39.868-89.047 89.047 0 49.179 39.868 89.047 89.047 89.047 31.684 0 59.498-16.55 75.282-41.475-13.042 14.526-31.963 23.665-53.021 23.665-39.342 0-71.237-31.893-71.237-71.237 0-39.344 31.895-71.237 71.237-71.237 21.058 0 39.978 9.138 53.02 23.663zm-4.785 47.574l80.543 26.169-49.778-68.514v84.688l49.778-68.514-80.543 26.171z"/></g></svg>
                    <span>T√ºrk√ße</span>
                  </div>
                  <div class="language-option" id="option-en" onclick="selectLanguage('en')">
                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55.2 38.4" style="enable-background:new 0 0 55.2 38.4" xml:space="preserve"><style type="text/css">.st0{fill:#FEFEFE;} .st1{fill:#C8102E;} .st2{fill:#012169;}</style><g><path class="st0" d="M2.87,38.4h49.46c1.59-0.09,2.87-1.42,2.87-3.03V3.03c0-1.66-1.35-3.02-3.01-3.03H3.01 C1.35,0.01,0,1.37,0,3.03v32.33C0,36.98,1.28,38.31,2.87,38.4L2.87,38.4z"/><polygon class="st1" points="23.74,23.03 23.74,38.4 31.42,38.4 31.42,23.03 55.2,23.03 55.2,15.35 31.42,15.35 31.42,0 23.74,0 23.74,15.35 0,15.35 0,23.03 23.74,23.03"/><path class="st2" d="M33.98,12.43V0h18.23c1.26,0.02,2.34,0.81,2.78,1.92L33.98,12.43L33.98,12.43z"/><path class="st2" d="M33.98,25.97V38.4h18.35c1.21-0.07,2.23-0.85,2.66-1.92L33.98,25.97L33.98,25.97z"/><path class="st2" d="M21.18,25.97V38.4H2.87c-1.21-0.07-2.24-0.85-2.66-1.94L21.18,25.97L21.18,25.97z"/><path class="st2" d="M21.18,12.43V0H2.99C1.73,0.02,0.64,0.82,0.21,1.94L21.18,12.43L21.18,12.43z"/><polygon class="st2" points="0,12.8 7.65,12.8 0,8.97 0,12.8"/><polygon class="st2" points="55.2,12.8 47.51,12.8 55.2,8.95 55.2,12.8"/><polygon class="st2" points="55.2,25.6 47.51,25.6 55.2,29.45 55.2,25.6"/><polygon class="st2" points="0,25.6 7.65,25.6 0,29.43 0,25.6"/><polygon class="st1" points="55.2,3.25 36.15,12.8 40.41,12.8 55.2,5.4 55.2,3.25"/><polygon class="st1" points="19.01,25.6 14.75,25.6 0,32.98 0,35.13 19.05,25.6 19.01,25.6"/><polygon class="st1" points="10.52,12.81 14.78,12.81 0,5.41 0,7.55 10.52,12.81"/><polygon class="st1" points="44.63,25.59 40.37,25.59 55.2,33.02 55.2,30.88 44.63,25.59"/></g></svg>
                    <span>English</span>
                  </div>
              </div>
            </div>
            
            <button id="logout" onclick="openLogoutModal()">Logout</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="grid-container">
        <!-- Client & Task Info -->
        <div>
          <div class="form-group">
            <label for="clientNameInput">Client</label>
            <input type="text" class="form-control" id="clientNameInput" style="width: 90%" readonly />
          </div>
          <div class="form-group">
            <label for="project">Project</label>
            <select id="project" class="form-control" onchange="loadTasksForProject()" style="width: 90%"></select>
          </div>
          <div class="form-group">
            <label for="task">Task</label>
            <select id="task" class="form-control" style="width: 90%">
              <option disabled selected value="">-- Select a Task --</option>
            </select>
          </div>
        </div>

        <!-- Timer Block -->
        <div class="container floating">
<div class="state-circle" id="stateCircle">
  <div class="state-label" id="stateLabel">IDLE</div>
</div>



          <div class="timer-display">
            <div class="timer-unit">
              <div class="timer-value" id="hours">00</div>
              <div class="timer-label">HRS</div>
            </div>
            <div class="timer-unit">
              <div class="timer-value" id="minutes">00</div>
              <div class="timer-label">MIN</div>
            </div>
            <div class="timer-unit">
              <div class="timer-value" id="seconds">00</div>
              <div class="timer-label">SEC</div>
            </div>
          </div>
<p id="statusText" style="text-align: center; color: #000; font-weight: bold; margin-top: 10px;"></p>

          <div class="action-buttons">
            <button class="action-button start-button" id="startBtn" style="color: #fff;">START</button>
        <!-- <button class="state-btn break" onclick="handleBreak()" id="breakBtn">‚òï Break</button> -->

            <button class="action-button reset-button" id="resetBtn" style="background-color: orange;">Finish</button>
          </div>
        </div>

        <!-- Misc Info -->
        <div>
          <div class="form-group">
            <label for="todayDate">Today</label>
            <input type="text" class="form-control" id="todayDate" disabled />
          </div>
          <div class="form-group">
            <label for="loggedTime">Total Logged In Time</label>
            <div id="loggedTime" class="form-control">00:00:00</div>
          </div>
          <div class="form-group">
            <label for="totaltimecount">Total Task Time Count</label>
            <div id="totaltimecount" class="form-control">00:00</div>
          </div>
          <div class="form-group">
            <label for="loggingInput">Screen Recording</label>
            <input type="text" class="form-control" id="loggingInput" value="NO" disabled />
          </div>
        </div>
      </div>

      <!-- Status Buttons -->
      <div class="controls">
    
      </div>

      <div id="work-animation" style="display: none; text-align: center; margin-top: 10px;">
        <img src="" alt="Working Animation" style="width: auto; border-radius: 8px; max-width: 250px;" />
        <p style="margin-top: 8px; font-weight: bold;">Welcome...</p>
      </div>
    </div>

    <!-- Navigation Menu -->
<div class="nav-container">
  <ul class="nav-menu">

    <li class="nav-item active">
      <a  class="" onclick="openInNewTab('https://crm.deluxebilisim.com/')">
<svg width="40px" height="40px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M23 9L19.8 12.1999L18 10.4M8 15C5.79086 15 4 16.7909 4 19V21H20V19C20 16.7909 18.2091 15 16 15H12M12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11C14.2091 11 16 9.20914 16 7C16 6.27143 15.8052 5.58835 15.4649 5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
      
      </a>
    </li>

    <li class="nav-item">
      <a  class="" data-page="help">
<svg fill="#000000" width="40px" height="40px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm1 16h-2v-2h2v2zm.976-4.885c-.196.158-.385.309-.535.459-.408.407-.44.777-.441.793v.133h-2v-.167c0-.118.029-1.177 1.026-2.174.195-.195.437-.393.691-.599.734-.595 1.216-1.029 1.216-1.627a1.934 1.934 0 0 0-3.867.001h-2C8.066 7.765 9.831 6 12 6s3.934 1.765 3.934 3.934c0 1.597-1.179 2.55-1.958 3.181z"/></svg>
       
      </a>  
    </li>

    <li class="nav-item">
      <a class="" data-page="settings">
       <svg width="40px" height="40px" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M600.704 64a32 32 0 0 1 30.464 22.208l35.2 109.376c14.784 7.232 28.928 15.36 42.432 24.512l112.384-24.192a32 32 0 0 1 34.432 15.36L944.32 364.8a32 32 0 0 1-4.032 37.504l-77.12 85.12a357.12 357.12 0 0 1 0 49.024l77.12 85.248a32 32 0 0 1 4.032 37.504l-88.704 153.6a32 32 0 0 1-34.432 15.296L708.8 803.904c-13.44 9.088-27.648 17.28-42.368 24.512l-35.264 109.376A32 32 0 0 1 600.704 960H423.296a32 32 0 0 1-30.464-22.208L357.696 828.48a351.616 351.616 0 0 1-42.56-24.64l-112.32 24.256a32 32 0 0 1-34.432-15.36L79.68 659.2a32 32 0 0 1 4.032-37.504l77.12-85.248a357.12 357.12 0 0 1 0-48.896l-77.12-85.248A32 32 0 0 1 79.68 364.8l88.704-153.6a32 32 0 0 1 34.432-15.296l112.32 24.256c13.568-9.152 27.776-17.408 42.56-24.64l35.2-109.312A32 32 0 0 1 423.232 64H600.64zm-23.424 64H446.72l-36.352 113.088-24.512 11.968a294.113 294.113 0 0 0-34.816 20.096l-22.656 15.36-116.224-25.088-65.28 113.152 79.68 88.192-1.92 27.136a293.12 293.12 0 0 0 0 40.192l1.92 27.136-79.808 88.192 65.344 113.152 116.224-25.024 22.656 15.296a294.113 294.113 0 0 0 34.816 20.096l24.512 11.968L446.72 896h130.688l36.48-113.152 24.448-11.904a288.282 288.282 0 0 0 34.752-20.096l22.592-15.296 116.288 25.024 65.28-113.152-79.744-88.192 1.92-27.136a293.12 293.12 0 0 0 0-40.256l-1.92-27.136 79.808-88.128-65.344-113.152-116.288 24.96-22.592-15.232a287.616 287.616 0 0 0-34.752-20.096l-24.448-11.904L577.344 128zM512 320a192 192 0 1 1 0 384 192 192 0 0 1 0-384zm0 64a128 128 0 1 0 0 256 128 128 0 0 0 0-256z"/></svg>
      </a>
    </li>

    <li class="nav-item">
      <a onclick="openReviewModal()" class="" data-page="logout">
       <svg fill="#000000" width="40px" height="40px" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg">
    <path d="M84 0v1423.143h437.875V1920l621.235-496.857h692.39V0H84Zm109.469 109.464H1726.03V1313.57h-621.235l-473.452 378.746V1313.57H193.469V109.464Z" fill-rule="evenodd"/>
</svg>
        
      </a>
    </li>

  </ul>
</div>


  </div>

  <!-- Smooth Drawer -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <figure style="display: flex; align-items: center; justify-content: center;">
        <img src="./static/dds-logo.png" alt="Logo" class="drawer-logo" width="250px">
       
      </figure>
      <!-- <button class="drawer-close" onclick="closeDrawer()" aria-label="Close menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button> -->
    </div>
    
    <div class="drawer-content">
      <div class="drawer-section">
        <div class="drawer-item project-info">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
          </svg>
          <div class="project-details">
            <!-- Only show the project name here per new requirement -->
            <div class="project-name" id="drawerProjectName">Proje Se√ßilmedi</div>
          </div>
        </div>
      </div>

      <div class="drawer-section">
  
        <div class="drawer-item task-info">
          <div class="task-details" style="cursor:pointer" onclick="openTaskDetailsModal(document.getElementById('drawerTaskName').textContent)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z"/>
            </svg>
            <div class="task-name" id="drawerTaskName">No Task Selected</div>
            <div class="task-status" id="drawerTaskStatus">L√ºtfen √ßalƒ±≈ümaya ba≈ülamak i√ßin bir g√∂rev se√ßin</div>
          </div>
        </div>
      </div>

      <div class="drawer-section">
    
        <div class="drawer-item time-info">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7H11V12.5L15.75,15.85L16.5,14.6L12.5,11.75V7Z"/>
          </svg>
          <div class="time-details">
            <div class="current-time" id="drawerCurrentTime">00:00:00</div>
            <div class="total-time" id="drawerTotalTime">Toplam: 00:00</div>
          </div>
        </div>
      </div>

  
    </div>
  </div>

  <!-- For Logout Modal  -->
    <div id="logoutModal" class="modal">
      <div class="modal-content">
        <h2 id="logoutModalTitle" data-translatable="logoutTitle">üîí Confirm Logout</h2>
        <p id="logoutModalDesc" data-translatable="logoutDesc">
          Are you sure you want to log out from DDS-FocusPro?
        </p>
        <div class="modal-buttons">
          <button class="modal-btn cancel-btn" onclick="closeLogoutModal()" data-translatable="logoutCancel">Cancel</button>
          <button class="modal-btn submit-btn" onclick="confirmLogout()" data-translatable="logoutConfirm">Logout</button>
        </div>
      </div>
    </div>
  </div> 

  

  <!-- Configuration Panel Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <h2>‚öôÔ∏è Configuration Settings</h2>
      <div style="text-align: left;">
        
        <!-- API Source Info -->
        <div class="config-section">
          <h3>üì° Configuration Source</h3>
          <p id="config-source-info">Loading...</p>
          <button onclick="refreshConfiguration()" class="modal-btn" style="margin-top: 10px;">
            üîÑ Refresh from API
          </button>
        </div>

        <!-- UI Settings -->
        <div class="config-section">
          <h3>üé® UI Settings</h3>
          <div class="config-row">
            <label>Primary Color:</label>
            <input type="color" id="config-primary-color" disabled>
            <span id="config-primary-color-value">#006039</span>
          </div>
          <div class="config-row">
            <label>Font Size:</label>
            <select id="config-font-size" disabled>
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
              <option value="extra_large">Extra Large</option>
            </select>
          </div>
        </div>

        <!-- Screenshot Settings -->
        <div class="config-section">
          <h3>üì∏ Screenshot Settings</h3>
          <div class="config-row">
            <label>Capture Interval:</label>
            <span id="config-screenshot-interval">60</span> seconds
          </div>
          <div class="config-row">
            <label>Quality:</label>
            <span id="config-screenshot-quality">85</span>%
          </div>
        </div>

        <!-- Features -->
        <div class="config-section">
          <h3>‚ú® Features</h3>
          <div class="config-row">
            <label>
              <input type="checkbox" id="feature-ai-analysis" disabled>
              AI Analysis
            </label>
          </div>
          <div class="config-row">
            <label>
              <input type="checkbox" id="feature-auto-categorization" disabled>
              Auto Categorization
            </label>
          </div>
          <div class="config-row">
            <label>
              <input type="checkbox" id="feature-idle-detection" disabled>
              Idle Detection
            </label>
          </div>
        </div>

      </div>
      <div class="modal-buttons">
        <button class="modal-btn cancel-btn" onclick="closeConfigModal()">Close</button>
      </div>
    </div>
  </div>

  <style>
    .config-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .config-section h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .config-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 5px 0;
    }
    .config-row label {
      font-weight: 500;
      flex: 1;
    }
    .config-row input, .config-row select {
      max-width: 150px;
    }
    #config-source-info {
      padding: 10px;
      background: #e8f5e8;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
    }
    /* Modal close button positioned top-right inside modal content */
    .modal .modal-close {
      position: absolute;
      top: 10px;
      right: 12px;
      background: rgba(0,0,0,0.06);
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      z-index: 60;
    }
    /* Ensure modal content is positioned relative so close button sits correctly */
    .modal .modal-content { position: relative; }
    .task-meta { display:flex; gap:16px; margin-bottom:10px; font-size:14px; }
    .task-desc { margin-top:8px; }
    .modal .error { color: #d33; font-weight:600; }
  </style>

   <!-- Logout Confirmation Modal -->
<!-- Idle Timeout Modal -->
<!-- Idle Timeout Modal -->
<!-- <div id="idleModal" class="modal">
  <div class="modal-content idle-shake" style="text-align: center;">
    <h2 id="idleModalTitle">‚è∏Ô∏è You're Idle</h2>
    <p id="idleModalDesc">You‚Äôve been inactive. Timer is paused.</p>
    
    <p id="idleCountdownText" style="font-size: 22px; font-weight: bold; color: #e67e22; margin-top: 10px;">
      Auto-saving in <span id="idleCounter">10</span> seconds...
    </p>

    <button onclick="cancelIdleCountdown()" 
            style="margin-top: 20px; padding: 10px 20px; font-size: 16px; font-weight: bold; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
      ‚ùå Cancel & Resume Work
    </button>
  </div>
</div> -->



<!-- For Idle Modal  -->
<div id="idleModal" class="modal" onclick="closeIdleModal()">
  <div class="modal-content idle-shake">
    <h2 id="idleModalTitle" data-translatable="idleTitle">‚è∏Ô∏è You're Idle</h2>
    <p id="idleModalDesc" data-translatable="idleDesc">You‚Äôve been inactive. Timer is paused.</p>
  </div>
</div>


  <!-- Modals -->
  <div id="finishModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">√ó</span>
      <h2 id="modalTitle">üìù Task Completion</h2>
      <p id="modalDesc">Please describe what you have completed for this task:</p>
      <textarea id="taskDetailInput" placeholder="Type your task details here..." rows="5"></textarea>
      <div class="modal-buttons">
        <button id="modalSubmitBtn" class="modal-btn submit-btn" onclick="submitTaskDetails()">Submit</button>
      </div>
    </div>
  </div>

    <!-- Task Details Modal -->
    <div id="taskDetailsModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="modal-close" onclick="closeTaskDetailsModal()">√ó</span>
        <h2 id="taskDetailsTitle">G√∂rev Detaylarƒ±</h2>
        <div id="taskDetailsBody">
          <!-- Task details will be injected here -->
        </div>
      </div>
    </div>

  <div id="reviewModal" class="modal-review">
    <div class="modal-content">
      <span class="modal-close" onclick="closeReviewModal()">√ó</span>
      <h2 id="reviewModalTitle">üí¨ Share Your Feedback</h2>
      <p id="reviewModalDesc">We'd love to hear your thoughts about DDSFocusPro:</p>
      <textarea id="reviewInput" placeholder="Type your feedback here..." rows="5"></textarea>
      <div class="modal-buttons">
        <button id="reviewSubmitBtn" class="modal-btn submit-btn" onclick="submitUserReview()">Submit Review</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="syncLoader" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 9999; justify-content: center; align-items: center;">
    <div style="padding: 20px; background: white; border-radius: 8px; font-weight: bold;">
      üîÑ Syncing timesheets...Please wait
    </div>
  </div>

  <!-- External Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- Configuration Manager removed - API functionality disabled -->
  <script>
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            const button = document.querySelector('.language-btn');
            
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

// ====== SMOOTH DRAWER FUNCTIONS ======
function toggleDrawer() {
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const arrowBtn = document.getElementById('drawerArrowBtn');
    
    if (drawer.classList.contains('active')) {
        closeDrawer();
    } else {
        openDrawer();
    }
}

function openDrawer() {
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const arrowBtn = document.getElementById('drawerArrowBtn');
    
    drawer.classList.add('active');
    overlay.classList.add('active');
    arrowBtn.classList.add('active');
    
    // Prevent body scroll when drawer is open
    document.body.style.overflow = 'hidden';
    
    // Add staggered animation to drawer sections
    const sections = document.querySelectorAll('.drawer-section');
    sections.forEach((section, index) => {
        section.style.animationDelay = `${0.1 + (index * 0.1)}s`;
        section.style.animation = 'slideInFromLeft 0.4s ease-out forwards';
    });
}

function closeDrawer() {
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const arrowBtn = document.getElementById('drawerArrowBtn');
    
    drawer.classList.remove('active');
    overlay.classList.remove('active');
    arrowBtn.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
    
    // Reset animations
    const sections = document.querySelectorAll('.drawer-section');
    sections.forEach((section) => {
        section.style.animation = '';
        section.style.animationDelay = '';
    });
}

// Helper functions for drawer actions
function showHelp() {
    closeDrawer();
    // Add help functionality here
    console.log('Help requested');
}

function openSettings() {
    closeDrawer();
    // Add settings functionality here
    console.log('Settings opened');
}

function showAbout() {
    closeDrawer();
    // Add about functionality here
    alert('DDS FocusPro v1.3\\n\\nA professional time tracking application for enhanced productivity.');
}

// ====== DRAWER INFO UPDATE FUNCTIONS ======
function updateDrawerProjectInfo() {
    const projectSelect = document.getElementById('project');
    const drawerProjectName = document.getElementById('drawerProjectName');
  // Only update the project name in the drawer (no client name)
  if (projectSelect && projectSelect.selectedOptions.length > 0) {
    const selectedProject = projectSelect.selectedOptions[0].text;

    // Get current language for translations
    const currentLang = sessionStorage.getItem('selectedLanguage') || 'tr';
    const translation = clientTranslations[currentLang] || clientTranslations.en;

    drawerProjectName.textContent = selectedProject !== translation.selectProject ? selectedProject : translation.noProjectSelected;
  } else {
    const currentLang = sessionStorage.getItem('selectedLanguage') || 'tr';
    const translation = clientTranslations[currentLang] || clientTranslations.en;

    drawerProjectName.textContent = translation.noProjectSelected;
  }
}

function updateDrawerTaskInfo() {
    const taskSelect = document.getElementById('task');
    const drawerTaskName = document.getElementById('drawerTaskName');
    const drawerTaskStatus = document.getElementById('drawerTaskStatus');
    const stateLabel = document.getElementById('stateLabel');
    
    // Get current language for translations
    const currentLang = sessionStorage.getItem('selectedLanguage') || 'tr';
    const translation = clientTranslations[currentLang] || clientTranslations.en;
    
    if (taskSelect && taskSelect.selectedOptions.length > 0) {
        const selectedTask = taskSelect.selectedOptions[0].text;
        const currentState = stateLabel ? stateLabel.textContent : 'IDLE';
        
        drawerTaskName.textContent = selectedTask !== translation.selectTask ? selectedTask : 'No Task Selected';
        drawerTaskStatus.textContent = selectedTask !== translation.selectTask ? `${translation.status} ${currentState}` : translation.pleaseSelectTask;
    } else {
        drawerTaskName.textContent = 'No Task Selected';
        drawerTaskStatus.textContent = translation.pleaseSelectTask;
    }
}

function updateDrawerTimeInfo() {
    const hoursElement = document.getElementById('hours');
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');
    const totalTimeElement = document.getElementById('totaltimecount');
    
    const drawerCurrentTime = document.getElementById('drawerCurrentTime');
    const drawerTotalTime = document.getElementById('drawerTotalTime');
    
    if (hoursElement && minutesElement && secondsElement) {
        const hours = hoursElement.textContent || '00';
        const minutes = minutesElement.textContent || '00';
        const seconds = secondsElement.textContent || '00';
        
        drawerCurrentTime.textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    if (totalTimeElement) {
        const totalTime = totalTimeElement.textContent || '00:00';
        // Get current language for translations
        const currentLang = sessionStorage.getItem('selectedLanguage') || 'tr';
        const translation = clientTranslations[currentLang] || clientTranslations.en;
        drawerTotalTime.textContent = `${translation.total} ${totalTime}`;
    }
}

// Auto-update drawer info every second
setInterval(function() {
    updateDrawerTimeInfo();
    updateDrawerTaskInfo(); // Update task status in case state changes
}, 1000);

// Update drawer info when dropdowns change
document.addEventListener('DOMContentLoaded', function() {
    const projectSelect = document.getElementById('project');
    const taskSelect = document.getElementById('task');
    
    if (projectSelect) {
        projectSelect.addEventListener('change', updateDrawerProjectInfo);
    }
    
    if (taskSelect) {
        taskSelect.addEventListener('change', updateDrawerTaskInfo);
    }
    
    // Initial update
    setTimeout(function() {
        updateDrawerProjectInfo();
        updateDrawerTaskInfo();
        updateDrawerTimeInfo();
    }, 500);
});

// Configuration Modal Functions
function openConfigModal() {
    const modal = document.getElementById('configModal');
    modal.style.display = 'flex';
    // Trigger animation after display is set
    setTimeout(() => {
      modal.classList.remove('hide');
      modal.classList.add('show');
    }, 10);
    updateConfigDisplay();
}

function closeConfigModal() {
    const modal = document.getElementById('configModal');
    modal.classList.remove('show');
    modal.classList.add('hide');
    
    // Hide modal after animation completes
    setTimeout(() => {
      modal.style.display = 'none';
      modal.classList.remove('hide');
    }, 300);
}

function updateConfigDisplay() {
    // ConfigManager API disabled - using static configuration
    console.log('‚ö†Ô∏è ConfigManager API disabled - using default settings');
    
    // Update source info with static values
    document.getElementById('config-source-info').innerHTML = `
        <strong>Theme:</strong> Default<br>
        <strong>Version:</strong> 1.4<br>
        <strong>Source:</strong> Static Configuration<br>
        <strong>Status:</strong> API Disabled
    `;
    
    // Set default values for other config displays if they exist
    const elements = {
        'config-font-size': '14px',
        'config-font-family': 'Segoe UI, sans-serif',
        'config-screenshot-interval': '60 seconds',
        'config-screenshot-quality': '85%',
        'config-ai-analysis': 'Enabled',
        'config-idle-detection': 'Enabled'
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
}

function updateLoggedTime() {
  const loginTime = localStorage.getItem("loginTime");
  if (!loginTime) return;

  const loggedTimeElement = document.getElementById("loggedTime");
  if (!loggedTimeElement) return;

  const elapsed = Date.now() - parseInt(loginTime);
  const totalSeconds = Math.floor(elapsed / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  loggedTimeElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
}

setInterval(updateLoggedTime, 1000);
updateLoggedTime();

async function refreshConfiguration() {
    try {
        console.log('üîÑ Configuration refresh requested - API disabled');
        const refreshBtn = event.target;
        refreshBtn.textContent = '‚ö†Ô∏è API Disabled';
        refreshBtn.disabled = true;

        setTimeout(() => {
            refreshBtn.textContent = '‚ùå API Disabled';
            refreshBtn.disabled = true;
        }, 1000);

        console.log('‚ö†Ô∏è ConfigManager API disabled - no refresh available');
    } catch (error) {
        console.error('‚ùå Configuration refresh error:', error);
    }
}

async function confirmLogout() {
  const user = JSON.parse(sessionStorage.getItem('user'));
  
  if (!user) {
    sessionStorage.clear();
    window.location.href = '/';
    return;
  }

  const loginTime = localStorage.getItem("loginTime");
  
  if (!loginTime) {
    sessionStorage.clear();
    window.location.href = '/';
    return;
  }

  const loginTimestamp = parseInt(loginTime);
  const logoutTimestamp = Date.now();
  const totalSeconds = Math.floor((logoutTimestamp - loginTimestamp) / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const total_duration = `${hours}h ${minutes}m ${seconds}s`;

  const payload = {
    email: user.email,
    staff_id: user.staffid,
    total_duration,
    total_seconds: totalSeconds
  };

  try {
    const response = await fetch("/api/store_logout_time", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (result.status !== "success") {
      console.error("Logout failed:", result.message);
    }
  } catch (error) {
    console.error("Error while calling logout API:", error);
  }

  // Clear storage and redirect after API call finishes
  localStorage.removeItem("loginTime");
  sessionStorage.removeItem("user");

  // Hide modal
  closeLogoutModal();

  // Small delay to ensure fetch finishes in some browsers
  setTimeout(() => {
    window.location.href = "/";
  }, 500);
}

// Close drawer when clicking outside
document.addEventListener('click', function(event) {
    const drawer = document.getElementById('drawer');
    const arrowBtn = document.getElementById('drawerArrowBtn');
    
    if (drawer && drawer.classList.contains('active')) {
        if (!drawer.contains(event.target) && !arrowBtn.contains(event.target)) {
            closeDrawer();
        }
    }
});

// Close drawer with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const drawer = document.getElementById('drawer');
        if (drawer && drawer.classList.contains('active')) {
            closeDrawer();
        }
    }
});

function selectLanguage(langCode) {
    const currentLanguage = document.getElementById('currentLanguage');

    // Define flag paths and labels
    const flags = {
        en: '/static/images/uk-flag.svg',
        tr: '/static/images/turkish-flag.svg'
    };

    const labels = {
        en: 'English',
        tr: 'T√ºrk√ße'
    };

    // Fallback to English if langCode is invalid
    if (!flags[langCode]) langCode = 'en';

    // ‚ú® Fade-out before changing content
    currentLanguage.style.opacity = 0;

    setTimeout(() => {
        // Update flag + label
        currentLanguage.innerHTML = `
            <span class="language-flag" style="background-image: url('${flags[langCode]}');"></span>
            ${labels[langCode]}
        `;

        // ‚ú® Fade-in after update
        currentLanguage.style.opacity = 1;
    }, 200); // match CSS transition duration

    // Save and apply language
    sessionStorage.setItem('selectedLanguage', langCode);
    applyClientLanguage(langCode);

    // Close dropdown
    document.getElementById('languageDropdown')?.classList.remove('show');
    document.querySelector('.language-btn')?.classList.remove('active');

    // Highlight selection
    document.getElementById('option-tr')?.classList.remove('selected');
    document.getElementById('option-en')?.classList.remove('selected');
    document.getElementById(`option-${langCode}`)?.classList.add('selected');
}

// Translation system for the client interface
const clientTranslations = {
    tr: {
        noProjectSelected: "Proje Se√ßilmedi",
        pleaseSelectProject: "L√ºtfen bir proje se√ßin",
        selectProject: "-- Proje Se√ßin --",
        selectTask: "-- ƒ∞≈ü Emri Se√ßin --",
        language: "Dil",
        status: "Durum:",
        total: "Toplam:",
        pleaseSelectTask: "L√ºtfen √ßalƒ±≈ümaya ba≈ülamak i√ßin bir g√∂rev se√ßin"
    },
    en: {
        noProjectSelected: "No Project Selected",
        pleaseSelectProject: "Please select a project", 
        selectProject: "-- Select a Project --",
        selectTask: "-- Select a Task --",
        language: "Language",
        status: "Status:",
        total: "Total:",
        pleaseSelectTask: "Please select a task to start working"
    }
};

function applyClientLanguage(langCode) {
    const translation = clientTranslations[langCode] || clientTranslations.en;
    
    // Update drawer project elements
    const drawerProjectName = document.getElementById('drawerProjectName');
    const drawerTaskStatus = document.getElementById('drawerTaskStatus');
    const drawerTotalTime = document.getElementById('drawerTotalTime');
    
    // Check if they currently have default text and update them
    if (drawerProjectName && (drawerProjectName.textContent === 'No Project Selected' || 
                             drawerProjectName.textContent === 'Proje Se√ßilmedi')) {
        drawerProjectName.textContent = translation.noProjectSelected;
    }
    
    // Update task status text
    if (drawerTaskStatus && (drawerTaskStatus.textContent === 'Please select a task to start working' || 
                            drawerTaskStatus.textContent === 'L√ºtfen √ßalƒ±≈ümaya ba≈ülamak i√ßin bir g√∂rev se√ßin')) {
        drawerTaskStatus.textContent = translation.pleaseSelectTask;
    }
    
    // Update total time text if it contains "Total:" or "Toplam:"
    if (drawerTotalTime) {
        const currentText = drawerTotalTime.textContent;
        if (currentText.startsWith('Total:') || currentText.startsWith('Toplam:')) {
            const timeValue = currentText.split(': ')[1] || '00:00';
            drawerTotalTime.textContent = `${translation.total} ${timeValue}`;
        }
    }
    
    // Update language button text if it shows default text
    const currentLanguage = document.getElementById('currentLanguage');
    if (currentLanguage && (currentLanguage.textContent === 'Language' || 
                           currentLanguage.textContent === 'Dil')) {
        // Don't change the language button text as it shows flags + text, handled in selectLanguage function
    }
}

// Initialize language on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedLanguage = sessionStorage.getItem('selectedLanguage') || 'tr';
    selectLanguage(savedLanguage);
});

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.language-btn') && !event.target.closest('.language-dropdown')) {
                const dropdown = document.getElementById('languageDropdown');
                const button = document.querySelector('.language-btn');
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    button.classList.remove('active');
                }
            }
        }

        // Handle window close events to ensure proper cleanup
        window.addEventListener('beforeunload', function(e) {
            console.log('üõë Window closing - stopping timer and cleaning up...');
            
            // Stop timer if it's running
            if (timerState.isRunning) {
                console.log('‚èπÔ∏è Stopping timer due to window close');
                try {
                    stopTimer();
                } catch (error) {
                    console.error('‚ùå Error stopping timer:', error);
                }
            }
            
            // Call shutdown endpoint to clean up background processes
            try {
                fetch('/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
            } catch (error) {
                console.error('‚ùå Error calling shutdown endpoint:', error);
            }
            
            // Don't show confirmation dialog, just clean up
            return undefined;
        });

        // Also handle unload event as a backup
        window.addEventListener('unload', function() {
            console.log('üóëÔ∏è Window unloading - final cleanup');
            
            // Send shutdown signal synchronously as a last resort
            try {
                navigator.sendBeacon('/shutdown', JSON.stringify({}));
            } catch (error) {
                console.error('‚ùå Error sending shutdown beacon:', error);
            }
        });

        // ‚úÖ Theme Toggle Functionality for Client Page
        function toggleClientTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update button icon
            updateClientThemeIcon(newTheme);
            
            console.log('Client theme changed to:', newTheme);
        }

        function updateClientThemeIcon(theme) {
            const sunIcon = document.querySelector('.theme-toggle-client .sun-icon');
            const moonIcon = document.querySelector('.theme-toggle-client .moon-icon');
            
            if (sunIcon && moonIcon) {
                if (theme === 'dark') {
                    sunIcon.style.setProperty('display', 'none', 'important');
                    moonIcon.style.setProperty('display', 'block', 'important');
                } else {
                    sunIcon.style.setProperty('display', 'block', 'important');
                    moonIcon.style.setProperty('display', 'none', 'important');
                }
            }
        }

        // Initialize theme on page load
        function initializeClientTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            console.log('Initializing client theme:', savedTheme);
            document.body.setAttribute('data-theme', savedTheme);
            
            // Wait a bit for DOM to be ready
            setTimeout(() => {
                updateClientThemeIcon(savedTheme);
            }, 100);
        }

        // Call initialize theme
        initializeClientTheme();

    // ====== Task Details Modal: fetch and render task notes, due date and remaining time ======
    async function openTaskDetailsModal(taskName) {
      const modal = document.getElementById('taskDetailsModal');
      const body = document.getElementById('taskDetailsBody');
      const title = document.getElementById('taskDetailsTitle');

      title.textContent = taskName || 'G√∂rev Detaylarƒ±';
      body.innerHTML = '<p>Y√ºkleniyor...</p>';
      modal.style.display = 'flex';

      try {
        // obtain token from sessionStorage; if not present, set a hardcoded token automatically
        let token = sessionStorage.getItem('authToken') || '';
        if (!token) {
          // Hardcoded token (inserted by frontend as requested)
          token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiZGVsdXhldGltZSIsIm5hbWUiOiJkZWx1eGV0aW1lIiwiQVBJX1RJTUUiOjE3NDUzNDQyNjJ9.kJGo5DksaPwkHwufDvLMGaMmjk5q2F7GhjzwdHtfT_o';
          try {
            sessionStorage.setItem('authToken', token);
          } catch (e) {
            console.warn('Could not persist authToken to sessionStorage:', e);
          }
        }

        const url = '/api/search-task?task_name=' + encodeURIComponent(taskName);
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

        const resp = await fetch(url, { headers });
        const data = await resp.json();

        if (Array.isArray(data) && data.length > 0) {
          const task = data[0];
          const description = task.description || '';
          const due = task.duedate || task.due_date || task.startdate || '';

          let remainingText = 'N/A';
          if (due) {
            // Try to parse date (handles 'YYYY-MM-DD' and full timestamps)
            const dueDate = new Date(due);
            if (!isNaN(dueDate.getTime())) {
              const now = new Date();
              const diffMs = dueDate - now;
              if (diffMs < 0) {
                remainingText = 'Overdue';
              } else {
                const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                remainingText = `${days}d ${hours}h ${mins}m`;
              }
            }
          }

          body.innerHTML = `
            <div class="task-meta">
              <div><strong>Due:</strong> ${due || 'N/A'}</div>
              <div><strong>Remaining:</strong> ${remainingText}</div>
            </div>
            <div class="task-desc">${description}</div>
          `;
        } else if (data && data.error) {
          body.innerHTML = `<p class="error">API Error: ${data.error}</p>`;
        } else {
          body.innerHTML = '<p>G√∂rev bulunamadƒ±.</p>';
        }
      } catch (err) {
        console.error('Error fetching task details', err);
        body.innerHTML = '<p class="error">A network error occurred while fetching task details.</p>';
      }
    }

    function closeTaskDetailsModal() {
      const modal = document.getElementById('taskDetailsModal');
      if (modal) modal.style.display = 'none';
    }

    // Close task details modal when clicking outside content
    document.addEventListener('click', function (event) {
      const modal = document.getElementById('taskDetailsModal');
      if (!modal) return;
      if (modal.style.display === 'flex' && event.target === modal) {
        closeTaskDetailsModal();
      }
    });

    // Close with Escape key
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        closeTaskDetailsModal();
      }
    });

    </script>
  
  <!-- Main Application Scripts -->
  <script src="../static/script/client.js"></script>
</body>

</html>
